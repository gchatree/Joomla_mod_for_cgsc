<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Information System</title>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        body {
            margin: 20px auto;
            padding: 0 20px;
            font-family: 'Sarabun', sans-serif;
        }

        /* Search Container */
        #searchContainer {
            display: flex;
            margin-bottom: 20px;
        }

        #studentIdInput {
            flex-grow: 1;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Sarabun', sans-serif;
        }

        #searchButton {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #searchButton:hover {
            background-color: #45a049;
        }

        /* Grid Container */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 0;
            margin-bottom: 20px;
        }

        @media screen and (max-width: 1024px) {
            .grid-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media screen and (max-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .student-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            background-color: white;
            text-decoration: none;
            color: inherit;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.6s ease-out;
        }

        .student-card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-5px);
        }

        .student-card.visible {
            opacity: 1;
            transform: scale(1);
        }

        .image-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }

        .image-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: top;
        }

        .image-circle .fa-user {
            font-size: 60px;
            color: #999;
        }

        .student-id {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .student-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .student-syndicate {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* Table Styles */
        #idListTable {
            width: 100%;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #idListTable th,
        #idListTable td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        #idListTable th {
            background-color: #f4f4f4;
            font-weight: bold;
        }

        #idListTable tbody tr {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #idListTable tbody tr:hover {
            background-color: #f5f5f5;
        }

        /* View Toggle Container */
        .view-toggle-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f0f0f0;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-toggle-btn.active {
            background-color: #4CAF50;
            color: white;
        }

        .view-toggle-btn:hover {
            opacity: 0.9;
        }

        /* Syndicate Dropdown */
        #syndicateSelect {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
        }

        .error-message {
            color: red;
            text-align: center;
            padding: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>

<body>
    <!-- Search Bar -->
    <div id="searchContainer">
        <input type="text" id="studentIdInput" placeholder="Enter Student ID or Name">
        <button id="searchButton">Search</button>
    </div>

    <!-- View Toggle Buttons and Syndicate Filter -->
    <div class="view-toggle-container">
        <button id="iconViewBtn" class="view-toggle-btn active">
            <i class="fas fa-th"></i> Icon View
        </button>
        <button id="listViewBtn" class="view-toggle-btn">
            <i class="fas fa-list"></i> List View
        </button>
        <select id="syndicateSelect">
            <option value="">All Syndicates</option>
        </select>
    </div>

    <!-- Student Grid -->
    <div class="grid-container" id="studentGrid">
        <div class="loading">กำลังโหลดข้อมูลนักเรียน...</div>
    </div>

    <!-- Student List -->
    <div id="idListContainer">
        <table id="idListTable">
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Full Name</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const STUDENT_DETAIL_URL = 'index.php?option=com_content&view=article&id=81&catid=2&Itemid=151';
        let studentData = [];
        let syndicates = new Set();

        function getStudentDetailUrl(studentId) {
            return `${STUDENT_DETAIL_URL}&stu_id=${studentId}`;
        }

        async function tryLoadImage(studentId) {
            const extensions = ['jpg', 'png', 'jpeg', 'gif'];

            const imagePromises = extensions.map(ext => {
                return new Promise((resolve) => {
                    const img = new Image();
                    const path = `/student_image/${studentId}.${ext}`;

                    img.onload = () => resolve(path);
                    img.onerror = () => resolve(null);
                    img.src = path;
                });
            });

            for (const imagePromise of imagePromises) {
                const path = await imagePromise;
                if (path) return path;
            }

            return null;
        }

        function filterStudents(searchTerm, selectedSyndicate) {
            return studentData.filter(student => {
                const matchesSearch = !searchTerm || 
                    student.stu_id.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    student.FullName.toLowerCase().includes(searchTerm.toLowerCase());
                
                const matchesSyndicate = !selectedSyndicate || 
                    student.Syndicate === selectedSyndicate;

                return matchesSearch && matchesSyndicate;
            });
        }

        function createStudentCards(students) {
            const grid = document.getElementById('studentGrid');
            grid.innerHTML = '';

            students.forEach(student => {
                const card = document.createElement('a');
                card.className = 'student-card';
                card.href = getStudentDetailUrl(student.stu_id);

                card.innerHTML = `
                    <div class="image-circle">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="student-id">${student.stu_id}</div>
                    <div class="student-name">${student.FullName}</div>
                    <div class="student-syndicate"> พวกที่ ${student.Syndicate || 'N/A'}</div>
                `;

                grid.appendChild(card);

                tryLoadImage(student.stu_id).then(imagePath => {
                    if (imagePath) {
                        const imageCircle = card.querySelector('.image-circle');
                        const img = document.createElement('img');
                        img.src = imagePath;
                        img.alt = student.FullName;

                        img.onload = () => {
                            imageCircle.innerHTML = '';
                            imageCircle.appendChild(img);
                        };
                    }
                }).catch(error => {
                    console.error(`Error loading image for student ${student.stu_id}:`, error);
                });
            });

            const observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                        }
                    });
                },
                {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px'
                }
            );

            document.querySelectorAll('.student-card').forEach(card => {
                observer.observe(card);
            });
        }

        function updateSyndicateDropdown() {
            const syndicateSelect = document.getElementById('syndicateSelect');
            syndicateSelect.innerHTML = '<option value="">All Syndicates</option>';
            
            Array.from(syndicates).sort().forEach(syndicate => {
                if (syndicate) {  // Only add non-empty syndicate values
                    const option = document.createElement('option');
                    option.value = syndicate;
                    option.textContent = syndicate;
                    syndicateSelect.appendChild(option);
                }
            });
        }

        function updateDisplayedStudents() {
            const searchTerm = document.getElementById('studentIdInput').value.trim();
            const selectedSyndicate = document.getElementById('syndicateSelect').value;
            const filteredStudents = filterStudents(searchTerm, selectedSyndicate);
            
            createStudentCards(filteredStudents);
            updateListView(filteredStudents);
        }

        function updateListView(students) {
            const tableBody = document.querySelector('#idListTable tbody');
            tableBody.innerHTML = '';
            
            students.forEach(student => {
                const row = document.createElement('tr');
                row.onclick = () => {
                    window.location.href = getStudentDetailUrl(student.stu_id);
                };
                row.innerHTML = `
                    <td>${student.stu_id}</td>
                    <td>${student.FullName}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function loadIdList() {
            try {
                const response = await fetch('/sheet/stu_id.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                studentData = data[0];

                // Collect unique syndicates
                studentData.forEach(student => {
                    if (student.Syndicate) {
                        syndicates.add(student.Syndicate);
                    }
                });

                updateSyndicateDropdown();
                updateDisplayedStudents();
            } catch (error) {
                console.error('Error loading ID list:', error);
                const errorMessage = '<tr><td colspan="3" style="color: red;">Error loading student list. Please try again later.</td></tr>';
                document.querySelector('#idListTable tbody').innerHTML = errorMessage;
                document.getElementById('studentGrid').innerHTML = `
                    <div class="error-message">
                        เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}
                        <br>
                        กรุณาตรวจสอบการเชื่อมต่อ
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadIdList();

            const searchButton = document.getElementById('searchButton');
            const studentIdInput = document.getElementById('studentIdInput');
            const iconViewBtn = document.getElementById('iconViewBtn');
            const listViewBtn = document.getElementById('listViewBtn');
            const syndicateSelect = document.getElementById('syndicateSelect');
            const gridContainer = document.getElementById('studentGrid');
            const listContainer = document.getElementById('idListContainer');

            function setIconView() {
                gridContainer.style.display = 'grid';
                listContainer.style.display = 'none';
                iconViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
            }

            function setListView() {
                gridContainer.style.display = 'none';
                listContainer.style.display = 'block';
                listViewBtn.classList.add('active');
                iconViewBtn.classList.remove('active');
            }

            setIconView();

            iconViewBtn.addEventListener('click', setIconView);
            listViewBtn.addEventListener('click', setListView);
            searchButton.addEventListener('click', updateDisplayedStudents);
            studentIdInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    updateDisplayedStudents();
                }
            });
            syndicateSelect.addEventListener('change', updateDisplayedStudents);
        });
    </script>
</body>

</html>